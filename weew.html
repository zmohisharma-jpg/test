<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade-In Admin Dashboard</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        @keyframes tradein-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
       
        .tradein-dashboard-wrapper tbody tr:hover {
            background: #f7fafc !important;
        }
       
        .tradein-dashboard-wrapper button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
       
        #editModal.show {
            display: flex !important;
        }
       
        #loadingOverlay.show {
            display: flex !important;
        }
    </style>
</head>
<body>

<div class="tradein-dashboard-wrapper" style="margin: 0; padding: 20px; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; line-height: 1.5; min-height: 100vh;">
   
    <div class="tradein-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h1 style="font-size: 2rem; margin: 0 0 10px 0; padding: 0; font-weight: 700; color: white;">üõ†Ô∏è Trade-In Admin Dashboard</h1>
        <p style="margin: 0; padding: 0; opacity: 0.95; font-size: 1rem;">Manage trade-in submissions, track packages, and process refunds</p>
    </div>

    <div class="tradein-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #f6ad55;">
            <h3 style="color: #718096; font-size: 0.9rem; font-weight: 600; margin: 0 0 10px 0; text-transform: uppercase;">Pending Shipment</h3>
            <div id="statPending" style="font-size: 2.2rem; font-weight: 700; color: #2d3748; margin: 0;">0</div>
        </div>
        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #48bb78;">
            <h3 style="color: #718096; font-size: 0.9rem; font-weight: 600; margin: 0 0 10px 0; text-transform: uppercase;">Items Received</h3>
            <div id="statReceived" style="font-size: 2.2rem; font-weight: 700; color: #2d3748; margin: 0;">0</div>
        </div>
        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #4299e1;">
            <h3 style="color: #718096; font-size: 0.9rem; font-weight: 600; margin: 0 0 10px 0; text-transform: uppercase;">Under Inspection</h3>
            <div id="statProcessing" style="font-size: 2.2rem; font-weight: 700; color: #2d3748; margin: 0;">0</div>
        </div>
        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #9f7aea;">
            <h3 style="color: #718096; font-size: 0.9rem; font-weight: 600; margin: 0 0 10px 0; text-transform: uppercase;">Completed</h3>
            <div id="statCompleted" style="font-size: 2.2rem; font-weight: 700; color: #2d3748; margin: 0;">0</div>
        </div>
    </div>

    <div class="tradein-controls" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); flex-wrap: wrap;">
        <input type="text" id="searchInput" placeholder="Search by Order ID, Trade-In ID, or Email..." style="flex: 1; min-width: 200px; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; box-sizing: border-box;">
        <select id="statusFilter" style="flex: 1; min-width: 150px; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; box-sizing: border-box;">
            <option value="">All Statuses</option>
            <option value="submitted">Submitted</option>
            <option value="in_transit">In Transit</option>
            <option value="received">Received</option>
            <option value="inspecting">Inspecting</option>
            <option value="approved">Approved</option>
            <option value="completed">Completed</option>
        </select>
        <button onclick="loadSubmissions()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.2s;">üîÑ Refresh</button>
    </div>

    <div class="tradein-table-container" style="background: white; border-radius: 12px; overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <table id="submissionsTable" style="width: 100%; border-collapse: collapse; margin: 0;">
            <thead style="background: #f7fafc;">
                <tr>
                    <th style="padding: 15px; text-align: left; font-weight: 600; color: #2d3748; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; border: none;">Order ID</th>
                    <th style="padding: 15px; text-align: left; font-weight: 600; color: #2d3748; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; border: none;">Trade-In ID</th>
                    <th style="padding: 15px; text-align: left; font-weight: 600; color: #2d3748; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; border: none;">Customer</th>
                    <th style="padding: 15px; text-align: left; font-weight: 600; color: #2d3748; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; border: none;">Tracking</th>
                    <th style="padding: 15px; text-align: left; font-weight: 600; color: #2d3748; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; border: none;">Status</th>
                    <th style="padding: 15px; text-align: left; font-weight: 600; color: #2d3748; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; border: none;">Submitted</th>
                    <th style="padding: 15px; text-align: left; font-weight: 600; color: #2d3748; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; border: none;">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="7" style="padding: 60px 20px; text-align: center; color: #718096; border: none;">
                        <div>Loading submissions...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999999; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-sizing: border-box;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
                <h2 style="color: #2d3748; margin: 0; font-size: 1.5rem;">Update Trade-In Status</h2>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #718096; padding: 0; line-height: 1;">&times;</button>
            </div>
            <form id="updateForm">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Order ID</label>
                    <input type="text" id="editOrderId" readonly style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: #f7fafc;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Trade-In ID</label>
                    <input type="text" id="editTradeInId" readonly style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: #f7fafc;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Submission Status</label>
                    <select id="editStatus" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
                        <option value="submitted">Submitted</option>
                        <option value="in_transit">In Transit</option>
                        <option value="received">Received</option>
                        <option value="inspecting">Inspecting</option>
                        <option value="approved">Approved</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Inspection Status</label>
                    <select id="editInspectionStatus" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Final Refund Amount ($)</label>
                    <input type="number" id="editFinalAmount" step="0.01" min="0" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Adjustment Reason (if different from quoted)</label>
                    <textarea id="editAdjustmentReason" placeholder="e.g., Minor scratches found, different model, etc." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; resize: vertical; min-height: 100px; box-sizing: border-box;"></textarea>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Payment Status</label>
                    <select id="editPaymentStatus" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="completed">Completed</option>
                        <option value="refunded">Refunded</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Inspection Notes</label>
                    <textarea id="editInspectionNotes" placeholder="Internal notes about the inspection..." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; resize: vertical; min-height: 100px; box-sizing: border-box;"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                    <button type="button" onclick="closeModal()" style="padding: 12px 25px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background: #e2e8f0; color: #2d3748;">Cancel</button>
                    <button type="submit" style="padding: 12px 25px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background: #48bb78; color: white;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); align-items: center; justify-content: center; z-index: 999998;">
        <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #667eea; border-radius: 50%; animation: tradein-spin 1s linear infinite;"></div>
    </div>
</div>

<script>
// Configuration
const CONFIG = {
    SUPABASE_URL: 'https://febbpukobbumunomfror.supabase.co',
    SUPABASE_SERVICE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlYmJwdWtvYmJ1bXVub21mcm9yIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDIyOTQzOCwiZXhwIjoyMDg1ODA1NDM4fQ.ONIau8Ci-Ys83qXKe1lQb3Pyk0vYQ21IGr8OeQOLHPE'
};

let currentSubmissionId = null;
let allSubmissions = [];

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadSubmissions();
   
    // Search functionality
    document.getElementById('searchInput').addEventListener('input', filterSubmissions);
    document.getElementById('statusFilter').addEventListener('change', filterSubmissions);
   
    // Form submission
    document.getElementById('updateForm').addEventListener('submit', handleUpdate);
});

// Load all submissions from Supabase
async function loadSubmissions() {
    showLoading(true);
    console.log('Starting fetch to Supabase');
    
    try {
        const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/complete_submission_view?select=*&order=created_at.desc`, {
            headers: {
                'apikey': CONFIG.SUPABASE_SERVICE_KEY,
                'Authorization': `Bearer ${CONFIG.SUPABASE_SERVICE_KEY}`
            }
        });
        
        console.log('Fetch response status:', response.status, 'OK:', response.ok);
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed with status ${response.status}: ${errorText}`);
        }
        
        allSubmissions = await response.json();
        console.log('Loaded submissions:', allSubmissions.length);
        
        updateStats();
        renderTable(allSubmissions);
    } catch (error) {
        console.error('Error loading submissions:', error);
        alert('Failed to load submissions: ' + error.message + '. Check console for details.');
    } finally {
        showLoading(false);
    }
}

// Update statistics cards
function updateStats() {
    const stats = {
        pending: 0,
        received: 0,
        processing: 0,
        completed: 0
    };
    
    allSubmissions.forEach(sub => {
        if (sub.submission_status === 'submitted' || sub.submission_status === 'in_transit') {
            stats.pending++;
        } else if (sub.submission_status === 'received') {
            stats.received++;
        } else if (sub.submission_status === 'inspecting') {
            stats.processing++;
        } else if (sub.submission_status === 'completed') {
            stats.completed++;
        }
    });
    
    document.getElementById('statPending').textContent = stats.pending;
    document.getElementById('statReceived').textContent = stats.received;
    document.getElementById('statProcessing').textContent = stats.processing;
    document.getElementById('statCompleted').textContent = stats.completed;
}

// Render table
function renderTable(submissions) {
    const tbody = document.getElementById('tableBody');
   
    if (submissions.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="padding: 60px 20px; text-align: center; color: #718096; border: none;">
                    <div>No submissions found</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = submissions.map(sub => `
        <tr>
            <td style="padding: 15px; border-top: 1px solid #e2e8f0;"><strong>${sub.order_id}</strong></td>
            <td style="padding: 15px; border-top: 1px solid #e2e8f0;">${sub.trade_in_id}</td>
            <td style="padding: 15px; border-top: 1px solid #e2e8f0;">${sub.customer_email}</td>
            <td style="padding: 15px; border-top: 1px solid #e2e8f0;">
                ${sub.tracking_number || 'N/A'}<br>
                <small style="color: #718096;">${sub.carrier || 'Unknown'}</small>
            </td>
            <td style="padding: 15px; border-top: 1px solid #e2e8f0;"><span style="display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; ${getStatusBadgeStyle(sub.submission_status)}">${formatStatus(sub.submission_status)}</span></td>
            <td style="padding: 15px; border-top: 1px solid #e2e8f0;">${formatDate(sub.created_at)}</td>
            <td style="padding: 15px; border-top: 1px solid #e2e8f0;">
                <button onclick="viewDetails('${sub.id}')" style="padding: 8px 15px; margin: 0 3px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; background: #4299e1; color: white;">üëÅÔ∏è View</button>
                <button onclick="openEditModal('${sub.id}')" style="padding: 8px 15px; margin: 0 3px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; background: #48bb78; color: white;">‚úèÔ∏è Edit</button>
                ${sub.tracking_url ? `<button onclick="window.open('${sub.tracking_url}', '_blank')" style="padding: 8px 15px; margin: 0 3px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; background: #f6ad55; color: white;">üì¶ Track</button>` : ''}
            </td>
        </tr>
    `).join('');
}

function getStatusBadgeStyle(status) {
    const styles = {
        'submitted': 'background: #bee3f8; color: #2c5282;',
        'in_transit': 'background: #feebc8; color: #7c2d12;',
        'received': 'background: #c6f6d5; color: #22543d;',
        'inspecting': 'background: #e9d5ff; color: #581c87;',
        'approved': 'background: #d9f99d; color: #365314;',
        'completed': 'background: #86efac; color: #14532d;'
    };
    return styles[status] || 'background: #e2e8f0; color: #2d3748;';
}

// Filter submissions
function filterSubmissions() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    
    const filtered = allSubmissions.filter(sub => {
        const matchesSearch = !searchTerm ||
            (sub.order_id && sub.order_id.toLowerCase().includes(searchTerm)) ||
            (sub.trade_in_id && sub.trade_in_id.toLowerCase().includes(searchTerm)) ||
            (sub.customer_email && sub.customer_email.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || sub.submission_status === statusFilter;
        
        return matchesSearch && matchesStatus;
    });
    
    renderTable(filtered);
}

// Open edit modal
function openEditModal(submissionId) {
    const submission = allSubmissions.find(s => s.id === submissionId);
    if (!submission) return;
    
    currentSubmissionId = submissionId;
    
    document.getElementById('editOrderId').value = submission.order_id || '';
    document.getElementById('editTradeInId').value = submission.trade_in_id || '';
    document.getElementById('editStatus').value = submission.submission_status || 'submitted';
    document.getElementById('editInspectionStatus').value = submission.inspection_status || 'pending';
    document.getElementById('editFinalAmount').value = submission.refund_amount || '';
    document.getElementById('editAdjustmentReason').value = submission.adjustment_reason || '';
    document.getElementById('editPaymentStatus').value = submission.payment_status || 'pending';
    document.getElementById('editInspectionNotes').value = submission.inspection_notes || '';
    
    document.getElementById('editModal').classList.add('show');
}

// Close modal
function closeModal() {
    document.getElementById('editModal').classList.remove('show');
    currentSubmissionId = null;
}

// Handle update submission
async function handleUpdate(e) {
    e.preventDefault();
    if (!currentSubmissionId) return;
    
    showLoading(true);
    
    const updateData = {
        submission_status: document.getElementById('editStatus').value,
        inspection_status: document.getElementById('editInspectionStatus').value,
        refund_amount: parseFloat(document.getElementById('editFinalAmount').value) || null,
        adjustment_reason: document.getElementById('editAdjustmentReason').value || null,
        payment_status: document.getElementById('editPaymentStatus').value,
        inspection_notes: document.getElementById('editInspectionNotes').value || null,
        updated_at: new Date().toISOString()
    };
    
    if (updateData.submission_status === 'completed') {
        updateData.completed_at = new Date().toISOString();
    }
    
    if (updateData.submission_status === 'received') {
        updateData.received_at = new Date().toISOString();
        updateData.item_received = true;
    }
    
    try {
        const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/trade_in_submissions?id=eq.${currentSubmissionId}`, {
            method: 'PATCH',
            headers: {
                'apikey': CONFIG.SUPABASE_SERVICE_KEY,
                'Authorization': `Bearer ${CONFIG.SUPABASE_SERVICE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify(updateData)
        });
        
        if (!response.ok) {
            const error = await response.text();
            throw new Error(`Update failed: ${error}`);
        }
        
        alert('‚úÖ Trade-in updated successfully!');
        closeModal();
        loadSubmissions();
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Failed to update: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// View details
function viewDetails(submissionId) {
    const submission = allSubmissions.find(s => s.id === submissionId);
    if (!submission) return;
    
    const details = `
Order ID: ${submission.order_id || 'N/A'}
Trade-In ID: ${submission.trade_in_id || 'N/A'}
Customer: ${submission.customer_email || 'N/A'}
Status: ${formatStatus(submission.submission_status) || 'N/A'}
Tracking: ${submission.tracking_number || 'N/A'}
Carrier: ${submission.carrier || 'N/A'}
Item Received: ${submission.item_received ? 'Yes' : 'No'}
Inspection: ${submission.inspection_status || 'Pending'}
Refund Amount: ${submission.refund_amount ? '$' + submission.refund_amount : 'Pending'}
Payment Status: ${submission.payment_status || 'Pending'}
Submitted: ${formatDate(submission.created_at) || 'N/A'}
${submission.received_at ? 'Received: ' + formatDate(submission.received_at) : ''}
${submission.completed_at ? 'Completed: ' + formatDate(submission.completed_at) : ''}
${submission.inspection_notes ? '\nNotes: ' + submission.inspection_notes : ''}
    `.trim();
    
    alert(details);
}

// Utility functions
function formatStatus(status) {
    if (!status) return 'Unknown';
    return status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (show) {
        overlay.classList.add('show');
    } else {
        overlay.classList.remove('show');
    }
}
</script>

</body>
</html>